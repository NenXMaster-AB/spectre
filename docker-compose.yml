# SPECTRE Docker Compose Configuration
# One-command deployment for the SPECTRE platform

services:
  # ============================================
  # SPECTRE API Service (FastAPI)
  # ============================================
  spectre-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: spectre:latest
    container_name: spectre-api
    restart: unless-stopped

    # Run the FastAPI server
    command: ["python", "-m", "uvicorn", "spectre.api.main:app", "--host", "0.0.0.0", "--port", "8000"]

    # Environment configuration
    environment:
      # LLM Configuration (user provides API keys)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # Threat Intel API Keys (optional)
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY:-}
      - SHODAN_API_KEY=${SHODAN_API_KEY:-}
      - GREYNOISE_API_KEY=${GREYNOISE_API_KEY:-}
      - OTX_API_KEY=${OTX_API_KEY:-}

      # SPECTRE Configuration
      - SPECTRE_LOG_LEVEL=${SPECTRE_LOG_LEVEL:-INFO}
      - SPECTRE_DATA=/data
      - SPECTRE_CONFIG=/config

    # Persistent volumes
    volumes:
      - spectre-data:/data
      - spectre-config:/config

    # Expose API port internally
    expose:
      - "8000"

    # Network configuration
    networks:
      - spectre-net

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Security options
    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # ============================================
  # SPECTRE Web UI (React + Nginx)
  # ============================================
  spectre-web:
    build:
      context: ./web
      dockerfile: Dockerfile
    image: spectre-web:latest
    container_name: spectre-web
    restart: unless-stopped

    # Expose web UI
    ports:
      - "3000:80"

    # Network configuration
    networks:
      - spectre-net

    # Wait for API to be ready
    depends_on:
      spectre-api:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx:mode=1777
      - /var/run:mode=1777

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ============================================
  # SPECTRE CLI Service (Interactive)
  # ============================================
  spectre:
    build:
      context: .
      dockerfile: Dockerfile
    image: spectre:latest
    container_name: spectre-cli
    profiles:
      - cli  # Only starts with: docker compose --profile cli up

    # Environment configuration
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY:-}
      - SHODAN_API_KEY=${SHODAN_API_KEY:-}
      - SPECTRE_LOG_LEVEL=${SPECTRE_LOG_LEVEL:-INFO}
      - SPECTRE_DATA=/data
      - SPECTRE_CONFIG=/config

    volumes:
      - spectre-data:/data
      - spectre-config:/config

    networks:
      - spectre-net

    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=100M

    stdin_open: true
    tty: true

  # ============================================
  # SPECTRE Heartbeat Service (Optional)
  # ============================================
  spectre-heartbeat:
    build:
      context: .
      dockerfile: Dockerfile
    image: spectre:latest
    container_name: spectre-heartbeat
    restart: unless-stopped
    profiles:
      - monitoring  # Only starts with: docker compose --profile monitoring up

    command: ["heartbeat", "start"]

    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY:-}
      - SHODAN_API_KEY=${SHODAN_API_KEY:-}
      - SPECTRE_LOG_LEVEL=${SPECTRE_LOG_LEVEL:-INFO}
      - SPECTRE_DATA=/data
      - SPECTRE_CONFIG=/config

    volumes:
      - spectre-data:/data
      - spectre-config:/config

    networks:
      - spectre-net

    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=100M

    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G

    depends_on:
      - spectre-api

# ============================================
# Networks
# ============================================
networks:
  spectre-net:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  spectre-data:
    driver: local
    name: spectre-data

  spectre-config:
    driver: local
    name: spectre-config
